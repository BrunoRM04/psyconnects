<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyConnects | Perfil</title>
    <link rel="stylesheet" href="../../public/css/styles.css">
    <link rel="shortcut icon" href="../../public/img/marca/icono.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-NSP4J1Q9MP"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-NSP4J1Q9MP');
</script>

<body>

    <header>

        <div class="logo">
            <img src="../../public/img/marca/icono 2.png" alt="Logo">
        </div>
        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>
        <nav class="nav-menu">
            <div class="close-menu">
                <i class="fas fa-times"></i>
            </div>
            <ul class="nav-links">
                <li><a href="../../index.html">游 Inicio</a></li>
                <li><a href="../../psicologos.html">游 Psic칩logos Disponibles</a></li>
                <li><a href="https://forms.gle/9U59hSXHtxS7qRbD8" target="_blank">游닉 Anunciarte</a></li>
                <li><a href="../../ofertas.html">游눺 Ofertas Laborales</a></li>
                <li><a href="../../login.html">游녻 Mi Cuenta</a></li>
                <li><a href="register.html">游 Registrarse</a></li>
            </ul>
        </nav>

    </header>

    <main>

        <div class="perfil-container">
            <div class="perfil-info">
                <div class="perfil-imagen">
                    <img id="fotoPerfil" src="../../public/img/default-profile.png" alt="Imagen de perfil del psic칩logo"
                        class="imagen-perfil">
                </div>
                <h2 id="nombre"></h2>
                <div class="detalles-container">
                    <div class="detalles-inline">
                        <div class="detalles" id="edad"></div>
                        <div class="detalles" id="pais"></div>
                        <div class="detalles" id="fechaNacimiento"></div>
                    </div>
                    <div class="detalles" id="correoElectronico"></div>
                    <a class="detalles" id="telefono" href="#"></a>
                    <div class="detalles" id="a침osExperiencia"></div>
                    <div class="detalles" id="idiomas"></div>
                    <div class="detalles" id="precioServicioHora"></div>
                </div>
                <button id="reservar-cita" class="reservar-btn">Reservar Cita &rarr;</button>
                <div class="redes-sociales">
                    <a id="linkedin" href="#" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                    <a id="facebook" href="#" target="_blank" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
                    <a id="twitter" href="#" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a id="instagram" href="#" target="_blank" aria-label="Instagram"><i
                            class="fab fa-instagram"></i></a>
                    <a id="youtube" href="#" target="_blank" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                    <a id="whatsapp" href="#" target="_blank" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    <a id="tiktok" href="#" target="_blank" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
                    <a id="snapchat" href="#" target="_blank" aria-label="Snapchat"><i class="fab fa-snapchat"></i></a>
                </div>
            </div>

            <div class="perfil-descripcion">
                <h3>Descripci칩n</h3>
                <p id="descripcion"></p>
                <h3>Experiencia</h3>
                <ul id="experiencia"></ul>
                <h3>Certificaciones</h3>
                <ul id="certificaciones"></ul>
            </div>
        </div>

        <div class="comment-box-section">
            <h2 class="comment-box-title">Valorar Psic칩logo/a</h2>
            <form id="commentForm" class="comment-form">
                <div class="input-group comment-input-group">
                    <span class="comment-emoji">游녻</span>
                    <input type="text" id="name" class="comment-input" placeholder="Nombre y apellido" required>
                </div>
                <div class="input-group comment-input-group">
                    <span class="comment-emoji">游깴</span>
                    <input type="text" id="country" class="comment-input" placeholder="Pa칤s" required>
                </div>
                <div class="input-group comment-input-group">
                    <span class="comment-emoji">游눫</span>
                    <textarea id="comment" class="comment-textarea" placeholder="Comentario" required></textarea>
                </div>
                <button type="submit" class="comment-submit">Valorar &rarr;</button>
            </form>
            <div id="commentList" class="comment-list"></div>
        </div>


        <div id="modalCalendario" class="modal" aria-hidden="true" role="dialog"
            aria-labelledby="tituloModalCalendario">
            <div class="modal-content">
                <button class="close" aria-label="Cerrar modal">&times;</button>
                <div class="contenido-calendario">
                    <div class="seccion-izquierda">
                        <div id="detalleFecha" class="detalle-fecha">
                            <div id="numeroFecha" class="numero-fecha">--</div>
                            <div id="nombreDia" class="nombre-dia-seleccionado">Selecciona un d칤a</div>
                            <div id="textoSeleccionar" class="texto-seleccionar">
                                Selecciona una fecha y hora para tu cita.
                            </div>
                        </div>

                        <div id="selectorHora" class="selector-hora" style="display: none;">
                            <label for="horaSeleccionada">Selecciona una Hora:</label>
                            <select id="horaSeleccionada" required>
                                <option value="" disabled selected>-- Selecciona una hora --</option>
                            </select>
                        </div>

                        <div class="input-group modal-input-group">
                            <label for="nombrePaciente">Nombre y Apellido:</label>
                            <input type="text" id="nombrePaciente" required>
                        </div>
                        <div class="input-group modal-input-group">
                            <label for="correoPaciente">Correo Electr칩nico:</label>
                            <input type="email" id="correoPaciente" required>
                        </div>
                        <!-- NUEVO: Selector de Pa칤s para el paciente -->
                        <div class="input-group modal-input-group">
                            <label for="paisPaciente">Pa칤s:</label>
                            <select id="paisPaciente" required>
                                <option value="" disabled selected>Seleccione su pa칤s</option>
                                <option value="+54">Argentina (+54)</option>
                                <option value="+591">Bolivia (+591)</option>
                                <option value="+55">Brasil (+55)</option>
                                <option value="+56">Chile (+56)</option>
                                <option value="+57">Colombia (+57)</option>
                                <option value="+506">Costa Rica (+506)</option>
                                <option value="+53">Cuba (+53)</option>
                                <option value="+1">Rep칰blica Dominicana (+1)</option>
                                <option value="+593">Ecuador (+593)</option>
                                <option value="+503">El Salvador (+503)</option>
                                <option value="+502">Guatemala (+502)</option>
                                <option value="+509">Hait칤 (+509)</option>
                                <option value="+504">Honduras (+504)</option>
                                <option value="+52">M칠xico (+52)</option>
                                <option value="+505">Nicaragua (+505)</option>
                                <option value="+507">Panam치 (+507)</option>
                                <option value="+595">Paraguay (+595)</option>
                                <option value="+51">Per칰 (+51)</option>
                                <option value="+598">Uruguay (+598)</option>
                                <option value="+58">Venezuela (+58)</option>
                            </select>
                        </div>
                        <!-- FIN selector de pa칤s -->
                        <div class="input-group modal-input-group">
                            <label for="telefonoPaciente">N칰mero de Tel칠fono:</label>
                            <input type="tel" id="telefonoPaciente" placeholder="+1234567890"
                                pattern="\+\d{1,3}\s?\d{4,14}(?:x.+)?$" required>
                        </div>

                        <button id="reservarCitaAhora" class="reservar-btn-2" style="display: none;" disabled>
                            Reservar Cita Ahora &rarr;
                        </button>
                        <button id="consultarDisponibilidad" class="consultar-btn" style="display: none;" disabled>
                            Consultar Disponibilidad &rarr;
                        </button>

                        <div id="precioSesionModal" class="precio-sesion-modal"
                            style="margin-top: 20px; font-weight: bold;">
                        </div>
                    </div>

                    <div class="seccion-derecha">
                        <h2 id="tituloModalCalendario">Selecciona el d칤a de la cita 游늰</h2>
                        <div class="navegacion-calendario">
                            <button id="mesAnterior" aria-label="Mes anterior">&lt;</button>
                            <span id="mesAnio"></span>
                            <button id="mesSiguiente" aria-label="Mes siguiente">&gt;</button>
                        </div>
                        <div id="calendario"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="alert-container"></div>

        <div id="loader" class="loader">
            <img src="../../public/img/marca/icono 2.png" alt="Logo de la Web" class="loader-logo">
            <p class="loader-text">Cargando... 游</p>
        </div>

    </main>

    <footer>

        <div class="footer-container">
            <div class="footer-nav">
                <a href="#">EMPRESAS</a>
                <a href="#">REGISTRARSE</a>
                <a href="../../doc/pdf/T칄RMINOS Y CONDICIONES - PSYCONNECTS.pdf">T칄RMINOS Y CONDICIONES</a>
                <a href="#">QUIENES SOMOS</a>
            </div>
            <div class="footer-social">
                <a href="https://www.instagram.com/psyconnects/"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/profile.php?id=61564496164581"><i class="fab fa-facebook"></i></a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Todos Los Derechos Reservados 2024 | @PsyConnects</p>
        </div>

    </footer>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, collection, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3YzDZbNdjZJL5siTvV9N2n1-z_tI5BvQ",
            authDomain: "psyconnects-7be13.firebaseapp.com",
            projectId: "psyconnects-7be13",
            storageBucket: "psyconnects-7be13.appspot.com",
            messagingSenderId: "299531221809",
            appId: "1:299531221809:web:c6bba4831be2d70d910e10",
            measurementId: "G-FKC5P4PE6V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        function mostrarAlerta(tipo, titulo, mensaje) {
            return new Promise((resolve) => {
                const alertContainer = document.getElementById('alert-container');

                const alert = document.createElement('div');
                alert.classList.add('alert');
                alert.classList.add(tipo === 'success' ? 'alert-success' : 'alert-error');

                alert.innerHTML = `
                    <div>
                        <strong>${titulo}</strong><br>
                        <span>${mensaje}</span>
                    </div>
                    <button class="close-btn">&times;</button>
                `;

                alertContainer.appendChild(alert);

                const closeBtn = alert.querySelector('.close-btn');
                closeBtn.addEventListener('click', () => cerrarAlerta(alert, resolve));

                setTimeout(() => cerrarAlerta(alert, resolve), 5000);
            });
        }

        function cerrarAlerta(alert, resolve) {
            alert.style.animation = 'slide-out 0.5s forwards';
            alert.addEventListener('animationend', () => {
                alert.remove();
                resolve();
            });
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const psicologoId = urlParams.get('id');

            if (!psicologoId) {
                mostrarAlerta('error', 'Error', 'Psic칩logo no encontrado en la URL.');
                return;
            }

            let psicologo;
            let disponibilidadData = {};

            try {
                const docRef = doc(db, "psicologos", psicologoId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    psicologo = docSnap.data();

                    disponibilidadData = psicologo.disponibilidad || {};

                    const fotoPerfilElement = document.getElementById('fotoPerfil');
                    fotoPerfilElement.src = psicologo.fotoPerfil || '../../public/img/default-profile.png';

                    document.getElementById('nombre').textContent = `${psicologo.nombre} ${psicologo.apellido}`;
                    document.getElementById('edad').textContent = `${calcularEdad(psicologo.fechaNacimiento)} A침os`;
                    document.getElementById('pais').textContent = psicologo.pais;
                    document.getElementById('fechaNacimiento').textContent = psicologo.fechaNacimiento;
                    document.getElementById('correoElectronico').textContent = psicologo.correoElectronico;
                    document.getElementById('telefono').textContent = psicologo.telefono;
                    document.getElementById('telefono').href = `https://wa.me/${psicologo.telefono.replace(/[^0-9]/g, '')}?text=${encodeURIComponent("Buenas, encontr칠 su perfil en PsyConnects.")}`;
                    document.getElementById('a침osExperiencia').textContent = `${psicologo.a침osExperiencia} a침os de experiencia`;
                    document.getElementById('idiomas').textContent = psicologo.idiomas.join(' - ');
                    document.getElementById('precioServicioHora').textContent = `${psicologo.precioServicioHora} USD x Hora`;
                    document.getElementById('descripcion').textContent = psicologo.descripcion;

                    const precioSesionModal = document.getElementById('precioSesionModal');
                    if (precioSesionModal) {
                        precioSesionModal.textContent = `Precio de sesi칩n: ${psicologo.precioServicioHora} USD`;
                    }

                    const experienciaList = document.getElementById('experiencia');
                    experienciaList.innerHTML = '';
                    psicologo.experiencia.forEach(exp => {
                        const li = document.createElement('li');
                        li.textContent = `${exp.puesto} en ${exp.institucion} (${exp.a침oInicio}-${exp.a침oFin})`;
                        experienciaList.appendChild(li);
                    });

                    const certificacionesList = document.getElementById('certificaciones');
                    certificacionesList.innerHTML = '';
                    psicologo.certificaciones.forEach(cert => {
                        const li = document.createElement('li');
                        li.textContent = `${cert.nombre} - ${cert.institucion} (${cert.a침o})`;
                        certificacionesList.appendChild(li);
                    });

                    const socialMedia = ['linkedin', 'facebook', 'twitter', 'instagram', 'youtube', 'whatsapp', 'tiktok', 'snapchat'];
                    socialMedia.forEach(media => {
                        const element = document.getElementById(media);
                        if (psicologo.redesSociales && psicologo.redesSociales[media]) {
                            element.href = psicologo.redesSociales[media];
                        } else {
                            element.style.display = 'none';
                        }
                    });

                    loadComments(psicologoId);
                } else {
                    mostrarAlerta('error', 'Error', 'Psic칩logo no encontrado en la base de datos.');
                }
            } catch (error) {
                console.error("Error al obtener los datos del psic칩logo desde Firestore: ", error);
                mostrarAlerta('error', 'Error', 'Error al obtener los datos del psic칩logo.');
            }

            function calcularEdad(fechaNacimiento) {
                const hoy = new Date();
                const fechaNac = new Date(fechaNacimiento);
                let edad = hoy.getFullYear() - fechaNac.getFullYear();
                const mes = hoy.getMonth() - fechaNac.getMonth();
                if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                    edad--;
                }
                return edad;
            }

            document.getElementById('commentForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                const name = document.getElementById('name').value;
                const country = document.getElementById('country').value;
                const comment = document.getElementById('comment').value;
                const newComment = { name, country, comment, timestamp: serverTimestamp() };

                try {
                    await addDoc(collection(db, 'comments', psicologoId, 'commentsList'), newComment);
                    appendComment(newComment);
                    document.getElementById('commentForm').reset();
                    mostrarAlerta('success', 'Comentario Agregado', 'Tu comentario ha sido agregado exitosamente.');
                } catch (error) {
                    console.error("Error adding comment: ", error);
                    mostrarAlerta('error', 'Error', 'Hubo un error al agregar tu comentario. Por favor, intenta de nuevo.');
                }
            });

            async function loadComments(psicologoId) {
                const q = query(collection(db, 'comments', psicologoId, 'commentsList'), orderBy('timestamp'));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    appendComment(doc.data());
                });
            }

            function appendComment(comment) {
                const commentList = document.getElementById('commentList');
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';

                const commentHeader = document.createElement('div');
                commentHeader.className = 'comment-item-header';

                const commentName = document.createElement('strong');
                commentName.textContent = `${comment.name}`;

                const commentCountry = document.createElement('small');
                commentCountry.innerHTML = `<i class="fas fa-globe"></i> ${comment.country}`;

                const commentText = document.createElement('p');
                commentText.textContent = comment.comment;

                commentHeader.appendChild(commentName);
                commentHeader.appendChild(commentCountry);
                commentItem.appendChild(commentHeader);
                commentItem.appendChild(commentText);

                commentList.appendChild(commentItem);
            }

            const modal = document.getElementById("modalCalendario");
            const btnReservarCita = document.getElementById("reservar-cita");
            const spanCerrar = document.querySelector(".close");
            const calendarioDiv = document.getElementById("calendario");
            const btnReservarCitaAhora = document.getElementById("reservarCitaAhora");
            const btnConsultarDisponibilidad = document.getElementById("consultarDisponibilidad");
            const selectorHoraDiv = document.getElementById('selectorHora');
            const horaInput = document.getElementById('horaSeleccionada');
            const mesAnioSpan = document.getElementById('mesAnio');
            const mesAnteriorBtn = document.getElementById('mesAnterior');
            const mesSiguienteBtn = document.getElementById('mesSiguiente');

            const numeroFechaDiv = document.getElementById('numeroFecha');
            const nombreDiaDiv = document.getElementById('nombreDia');
            const textoSeleccionarDiv = document.getElementById('textoSeleccionar');

            const nombrePacienteInput = document.getElementById('nombrePaciente');
            const correoPacienteInput = document.getElementById('correoPaciente');
            const telefonoPacienteInput = document.getElementById('telefonoPaciente');
            const paisPacienteSelect = document.getElementById('paisPaciente');

            let fechaSeleccionadaGlobal = null;
            let horasDisponibles = [];

            const fechaInicial = new Date();
            let mesActual = fechaInicial.getMonth();
            let anioActual = fechaInicial.getFullYear();

            const hoy = new Date();

            function actualizarMesAnio() {
                const opciones = { month: 'long', year: 'numeric' };
                const fecha = new Date(anioActual, mesActual);
                mesAnioSpan.textContent = fecha.toLocaleDateString('es-ES', opciones);
            }

            function actualizarBotonMesAnterior() {
                if (anioActual > fechaInicial.getFullYear() || (anioActual === fechaInicial.getFullYear() && mesActual > fechaInicial.getMonth())) {
                    mesAnteriorBtn.disabled = false;
                    mesAnteriorBtn.style.cursor = 'pointer';
                    mesAnteriorBtn.style.opacity = '1';
                } else {
                    mesAnteriorBtn.disabled = true;
                    mesAnteriorBtn.style.cursor = 'not-allowed';
                    mesAnteriorBtn.style.opacity = '0.5';
                }
            }

            function generarCalendario(mes, anio) {
                calendarioDiv.innerHTML = '';

                const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b'];
                diasSemana.forEach(dia => {
                    const diaHeader = document.createElement('div');
                    diaHeader.className = 'nombre-dia';
                    diaHeader.textContent = dia;
                    calendarioDiv.appendChild(diaHeader);
                });

                const primerDia = new Date(anio, mes, 1).getDay();
                const diasEnMes = new Date(anio, mes + 1, 0).getDate();

                const esMesActual = (mes === fechaInicial.getMonth()) && (anio === fechaInicial.getFullYear());

                for (let i = 0; i < primerDia; i++) {
                    const espacio = document.createElement('div');
                    calendarioDiv.appendChild(espacio);
                }

                for (let dia = 1; dia <= diasEnMes; dia++) {
                    const diaDiv = document.createElement('div');
                    diaDiv.className = 'dia-calendario';
                    diaDiv.textContent = dia;

                    const fechaDia = new Date(anio, mes, dia);
                    const fechaFormateada = fechaDia.toISOString().split('T')[0];

                    if (disponibilidadData[fechaFormateada] && disponibilidadData[fechaFormateada].length > 0) {
                        diaDiv.classList.add('dia-disponible');
                    }

                    if (esMesActual && dia < hoy.getDate()) {
                        diaDiv.classList.add('dia-disabled');
                        diaDiv.style.pointerEvents = 'none';
                    } else {
                        diaDiv.addEventListener('click', function () {
                            seleccionarDia(diaDiv, anio, mes, dia, fechaFormateada);
                        });
                    }

                    if (esMesActual && dia === hoy.getDate()) {
                        diaDiv.classList.add('dia-hoy');
                    }

                    calendarioDiv.appendChild(diaDiv);
                }

                actualizarMesAnio();
                actualizarBotonMesAnterior();
            }

            function seleccionarDia(diaDiv, anio, mes, dia, fechaFormateada) {
                const diasSeleccionables = document.querySelectorAll('.dia-calendario');
                diasSeleccionables.forEach(d => d.classList.remove('dia-seleccionado'));

                diaDiv.classList.add('dia-seleccionado');

                fechaSeleccionadaGlobal = new Date(anio, mes, dia);
                selectorHoraDiv.style.display = "flex";
                btnReservarCitaAhora.style.display = "none";
                btnConsultarDisponibilidad.style.display = "none";

                horasDisponibles = disponibilidadData[fechaFormateada] || [];

                actualizarDetalleFecha();

                if (horasDisponibles.length > 0) {
                    generarOpcionesHoras();
                    horaInput.style.display = "block";
                    btnConsultarDisponibilidad.style.display = "none";
                } else {
                    horaInput.style.display = "none";
                    btnConsultarDisponibilidad.style.display = "inline-block";
                }

                verificarCamposModal();
            }

            function actualizarDetalleFecha() {
                if (fechaSeleccionadaGlobal) {
                    const dia = fechaSeleccionadaGlobal.getDate();
                    const mes = fechaSeleccionadaGlobal.getMonth();
                    const anio = fechaSeleccionadaGlobal.getFullYear();
                    const nombreDia = fechaSeleccionadaGlobal.toLocaleDateString('es-ES', { weekday: 'long' });

                    numeroFechaDiv.textContent = dia.toString().padStart(2, '0');
                    nombreDiaDiv.textContent = nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1);
                    actualizarTextoSeleccionar();
                } else {
                    numeroFechaDiv.textContent = '--';
                    nombreDiaDiv.textContent = 'Selecciona un d칤a';
                    textoSeleccionarDiv.textContent = 'Selecciona una fecha y hora para tu cita.';
                }
            }

            function actualizarTextoSeleccionar() {
                if (fechaSeleccionadaGlobal && horaInput.value) {
                    const dia = fechaSeleccionadaGlobal.getDate().toString().padStart(2, '0');
                    const mes = (fechaSeleccionadaGlobal.getMonth() + 1).toString().padStart(2, '0');
                    const anio = fechaSeleccionadaGlobal.getFullYear();
                    const hora = horaInput.value;

                    const fechaFormateada = `${dia}/${mes}/${anio}`;
                    const horaFormateada = hora;

                    textoSeleccionarDiv.textContent = `Seleccionar cita para el ${fechaFormateada} (${nombreDiaDiv.textContent}) a las ${horaFormateada}.`;
                } else if (fechaSeleccionadaGlobal) {
                    const dia = fechaSeleccionadaGlobal.getDate().toString().padStart(2, '0');
                    const mes = (fechaSeleccionadaGlobal.getMonth() + 1).toString().padStart(2, '0');
                    const anio = fechaSeleccionadaGlobal.getFullYear();
                    const nombreDia = fechaSeleccionadaGlobal.toLocaleDateString('es-ES', { weekday: 'long' });

                    const fechaFormateada = `${dia}/${mes}/${anio}`;

                    textoSeleccionarDiv.textContent = `Seleccionar cita para el ${fechaFormateada} (${nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1)}) a las --:--.`;
                } else {
                    textoSeleccionarDiv.textContent = 'Selecciona una fecha y hora para tu cita.';
                }
            }

            function generarOpcionesHoras() {
                const horaSeleccionada = document.getElementById('horaSeleccionada');
                horaSeleccionada.innerHTML = '';

                if (horasDisponibles.length > 0) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    defaultOption.textContent = '-- Selecciona una hora --';
                    horaSeleccionada.appendChild(defaultOption);

                    horasDisponibles.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora;
                        option.textContent = hora;
                        horaSeleccionada.appendChild(option);
                    });
                    horaSeleccionada.disabled = false;
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No hay horas disponibles';
                    horaSeleccionada.appendChild(option);
                    horaSeleccionada.disabled = true;
                }
            }

            generarCalendario(mesActual, anioActual);
            actualizarMesAnio();

            mesAnteriorBtn.addEventListener('click', function () {
                if (mesActual > fechaInicial.getMonth() || anioActual > fechaInicial.getFullYear()) {
                    if (mesActual === 0) {
                        mesActual = 11;
                        anioActual--;
                    } else {
                        mesActual--;
                    }
                    actualizarMesAnio();
                    generarCalendario(mesActual, anioActual);
                    resetModal();
                }
            });

            mesSiguienteBtn.addEventListener('click', function () {
                mesActual++;
                if (mesActual > 11) {
                    mesActual = 0;
                    anioActual++;
                }
                actualizarMesAnio();
                generarCalendario(mesActual, anioActual);
                resetModal();
            });

            btnReservarCita.addEventListener('click', function () {
                modal.style.display = "block";
                verificarCamposModal();
            });

            spanCerrar.addEventListener('click', function () {
                modal.style.display = "none";
                resetModal();
            });

            window.addEventListener('click', function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                    resetModal();
                }
            });

            horaInput.addEventListener('change', function () {
                if (horaInput.value && fechaSeleccionadaGlobal) {
                    btnReservarCitaAhora.style.display = "inline-block";
                } else {
                    btnReservarCitaAhora.style.display = "none";
                }
                actualizarTextoSeleccionar();
                verificarCamposModal();
            });

            nombrePacienteInput.addEventListener('input', verificarCamposModal);
            correoPacienteInput.addEventListener('input', verificarCamposModal);
            telefonoPacienteInput.addEventListener('input', verificarCamposModal);

            paisPacienteSelect.addEventListener('change', function () {
                const selectedPrefix = paisPacienteSelect.value;
                if (!telefonoPacienteInput.value.startsWith(selectedPrefix)) {
                    telefonoPacienteInput.value = selectedPrefix;
                }
            });

            async function registrarReserva(actionType, nombrePaciente, correoPaciente, telefonoPaciente) {
                try {
                    await addDoc(collection(db, 'reservas'), {
                        psicologoId: psicologoId,
                        actionType: actionType,
                        timestamp: serverTimestamp(),
                        fechaSeleccionada: fechaSeleccionadaGlobal ? fechaSeleccionadaGlobal.toISOString().split('T')[0] : null,
                        horaSeleccionada: horaInput.value || null,
                        nombrePaciente: nombrePaciente,
                        correoPaciente: correoPaciente,
                        telefonoPaciente: telefonoPaciente,
                        correoPsicologo: psicologo.correoElectronico || null,
                        userAgent: navigator.userAgent
                    });
                    console.log(`Acci칩n '${actionType}' registrada exitosamente.`);
                } catch (error) {
                    console.error("Error al registrar la acci칩n de reserva: ", error);
                    mostrarAlerta('error', 'Error', 'Hubo un error al registrar tu reserva. Por favor, intenta de nuevo.');
                }
            }

            const loader = document.getElementById('loader');

            btnReservarCitaAhora.addEventListener('click', async function () {
                const nombrePaciente = nombrePacienteInput.value.trim();
                const correoPaciente = correoPacienteInput.value.trim();
                const telefonoPaciente = telefonoPacienteInput.value.trim();

                if (!nombrePaciente || !correoPaciente || !telefonoPaciente) {
                    mostrarAlerta('error', 'Campos Incompletos', 'Por favor, completa tu nombre, correo electr칩nico y n칰mero de tel칠fono.');
                    return;
                }

                if (!fechaSeleccionadaGlobal) {
                    mostrarAlerta('error', 'Fecha No Seleccionada', 'Por favor, selecciona una fecha para tu cita.');
                    return;
                }

                if (!horaInput.value) {
                    mostrarAlerta('error', 'Hora No Seleccionada', 'Por favor, selecciona una hora para tu cita.');
                    return;
                }

                const dia = fechaSeleccionadaGlobal.getDate().toString().padStart(2, '0');
                const mes = (fechaSeleccionadaGlobal.getMonth() + 1).toString().padStart(2, '0');
                const anio = fechaSeleccionadaGlobal.getFullYear();
                const hora = horaInput.value;

                const fechaFormateada = `${dia}/${mes}/${anio}`;
                const horaFormateada = hora;

                loader.classList.add('active');

                await registrarReserva('reservar ahora', nombrePaciente, correoPaciente, telefonoPaciente);

                const formData = {
                    name: nombrePaciente,
                    email: correoPaciente,
                    phone: telefonoPaciente,
                    appointment_date: fechaFormateada,
                    appointment_time: horaFormateada,
                    psychologist_id: psicologoId,
                    psychologist_name: `${psicologo.nombre} ${psicologo.apellido}`,
                    psychologist_email: psicologo.correoElectronico,
                    _template: 'table'
                };

                const urlEncodedData = new URLSearchParams(formData);

                fetch('https://formsubmit.co/ajax/sesionespsyconnects@gmail.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: urlEncodedData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            mostrarAlerta('success', 'Reserva Exitosa', 'Muchas gracias por tu reserva, te enviaremos m치s informaci칩n a tu correo electr칩nico 游땕');
                        } else {
                            throw new Error(data.message || 'Error desconocido');
                        }

                        modal.style.display = "none";
                        resetModal();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarAlerta('error', 'Error en la Reserva', 'Ocurri칩 un error al enviar el formulario. Por favor, intenta nuevamente.');
                    })
                    .finally(() => {
                        loader.classList.remove('active');
                    });
            });

            btnConsultarDisponibilidad.addEventListener('click', async function () {
                const nombrePaciente = nombrePacienteInput.value.trim();
                const correoPaciente = correoPacienteInput.value.trim();
                const telefonoPaciente = telefonoPacienteInput.value.trim();

                if (!nombrePaciente || !correoPaciente || !telefonoPaciente) {
                    mostrarAlerta('error', 'Campos Incompletos', 'Por favor, completa tu nombre, correo electr칩nico y n칰mero de tel칠fono.');
                    return;
                }

                if (!fechaSeleccionadaGlobal) {
                    mostrarAlerta('error', 'Fecha No Seleccionada', 'Por favor, selecciona una fecha para consultar disponibilidad.');
                    return;
                }

                const dia = fechaSeleccionadaGlobal.getDate().toString().padStart(2, '0');
                const mes = (fechaSeleccionadaGlobal.getMonth() + 1).toString().padStart(2, '0');
                const anio = fechaSeleccionadaGlobal.getFullYear();

                const fechaFormateada = `${dia}/${mes}/${anio}`;

                loader.classList.add('active');

                await registrarReserva('consultar disponibilidad', nombrePaciente, correoPaciente, telefonoPaciente);

                const formData = {
                    name: nombrePaciente,
                    email: correoPaciente,
                    phone: telefonoPaciente,
                    requested_date: fechaFormateada,
                    psychologist_id: psicologoId,
                    psychologist_name: `${psicologo.nombre} ${psicologo.apellido}`,
                    psychologist_email: psicologo.correoElectronico,
                    _template: 'table'
                };

                const urlEncodedData = new URLSearchParams(formData);

                fetch('https://formsubmit.co/ajax/sesionespsyconnects@gmail.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: urlEncodedData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            mostrarAlerta('success', 'Consulta Exitosa', 'Muchas gracias por tu consulta, te enviaremos m치s informaci칩n a tu correo electr칩nico 游땕');
                        } else {
                            throw new Error(data.message || 'Error desconocido');
                        }

                        modal.style.display = "none";
                        resetModal();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarAlerta('error', 'Error en la Consulta', 'Ocurri칩 un error al enviar el formulario. Por favor, intenta nuevamente.');
                    })
                    .finally(() => {
                        loader.classList.remove('active');
                    });
            });

            function resetModal() {
                const diasSeleccionables = document.querySelectorAll('.dia-calendario');
                diasSeleccionables.forEach(d => {
                    d.classList.remove('dia-seleccionado');
                    d.style.pointerEvents = '';
                });

                selectorHoraDiv.style.display = "none";
                btnReservarCitaAhora.style.display = "none";
                btnConsultarDisponibilidad.style.display = "none";

                fechaSeleccionadaGlobal = null;
                horasDisponibles = [];
                horaInput.innerHTML = '';
                horaInput.value = "";

                nombrePacienteInput.value = '';
                correoPacienteInput.value = '';
                telefonoPacienteInput.value = '';
                if (paisPacienteSelect) {
                    paisPacienteSelect.selectedIndex = 0;
                }

                actualizarDetalleFecha();

                btnReservarCitaAhora.disabled = true;
                btnConsultarDisponibilidad.disabled = true;

                const precioSesionModal = document.getElementById('precioSesionModal');
                if (precioSesionModal) {
                    precioSesionModal.textContent = `Precio de sesi칩n (1 hora): ${psicologo.precioServicioHora} USD`;
                }
            }

            function verificarCamposModal() {
                const nombrePaciente = nombrePacienteInput.value.trim();
                const correoPaciente = correoPacienteInput.value.trim();
                const telefonoPaciente = telefonoPacienteInput.value.trim();

                const camposLlenos = nombrePaciente && correoPaciente && telefonoPaciente;

                if (camposLlenos) {
                    if (horasDisponibles.length > 0 && horaInput.value) {
                        btnReservarCitaAhora.disabled = false;
                        btnConsultarDisponibilidad.disabled = true;
                    } else if (horasDisponibles.length === 0) {
                        btnConsultarDisponibilidad.disabled = false;
                        btnReservarCitaAhora.disabled = true;
                    } else if (horasDisponibles.length > 0 && !horaInput.value) {
                        btnReservarCitaAhora.disabled = true;
                        btnConsultarDisponibilidad.disabled = true;
                    }
                } else {
                    btnReservarCitaAhora.disabled = true;
                    btnConsultarDisponibilidad.disabled = true;
                }
            }

            nombrePacienteInput.addEventListener('input', verificarCamposModal);
            correoPacienteInput.addEventListener('input', verificarCamposModal);
            telefonoPacienteInput.addEventListener('input', verificarCamposModal);

            horaInput.addEventListener('change', verificarCamposModal);

            document.querySelector('.menu-toggle').addEventListener('click', function () {
                document.querySelector('.nav-menu').classList.add('active');
            });

            document.querySelector('.close-menu').addEventListener('click', function () {
                document.querySelector('.nav-menu').classList.remove('active');
            });
        });

    </script>

</body>

</html>