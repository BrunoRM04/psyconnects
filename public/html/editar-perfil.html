<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyConnects | Editar Perfil</title>
    <link rel="stylesheet" href="../../public/css/styles.css">
    <link rel="shortcut icon" href="../../public/img/marca/icono.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script type="module">
        // Import Firebase y Firestore
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA3YzDZbNdjZJL5siTvV9N2n1-z_tI5BvQ",
            authDomain: "psyconnects-7be13.firebaseapp.com",
            projectId: "psyconnects-7be13",
            storageBucket: "psyconnects-7be13.appspot.com",
            messagingSenderId: "299531221809",
            appId: "1:299531221809:web:c6bba4831be2d70d910e10",
            measurementId: "G-FKC5P4PE6V"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const psicologoId = parseInt(urlParams.get('id'), 10);

            // Cargar los datos actuales del psicólogo
            fetch('../../json/psicologos.json')
                .then(response => response.json())
                .then(data => {
                    const psicologo = data.psicologos.find(psic => psic.id === psicologoId);
                    if (psicologo) {
                        document.getElementById('nombre').value = psicologo.nombre;
                        document.getElementById('apellido').value = psicologo.apellido;
                        document.getElementById('pais').value = psicologo.pais;
                        document.getElementById('correoElectronico').value = psicologo.correoElectronico;
                        document.getElementById('telefono').value = psicologo.telefono;
                        document.getElementById('añosExperiencia').value = psicologo.añosExperiencia;
                        document.getElementById('idiomas').value = psicologo.idiomas.join(', ');
                        document.getElementById('precioServicioHora').value = psicologo.precioServicioHora;
                        document.getElementById('descripcion').value = psicologo.descripcion;

                        // Cargar experiencia
                        const experienciaContainer = document.getElementById('experiencia-container');
                        psicologo.experiencia.forEach((exp, index) => {
                            agregarEntradaExperiencia(exp, index);
                        });

                        // Cargar certificaciones
                        const certificacionesContainer = document.getElementById('certificaciones-container');
                        psicologo.certificaciones.forEach((cert, index) => {
                            agregarEntradaCertificacion(cert, index);
                        });
                    } else {
                        alert('Psicólogo no encontrado');
                    }
                });

            // Guardar cambios
            document.getElementById('editForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const nombre = document.getElementById('nombre').value;
                const apellido = document.getElementById('apellido').value;
                const pais = document.getElementById('pais').value;
                const correoElectronico = document.getElementById('correoElectronico').value;
                const telefono = document.getElementById('telefono').value;
                const añosExperiencia = document.getElementById('añosExperiencia').value;
                const idiomas = document.getElementById('idiomas').value.split(',').map(i => i.trim());
                const precioServicioHora = document.getElementById('precioServicioHora').value;
                const descripcion = document.getElementById('descripcion').value;

                // Obtener experiencia
                const experiencia = [];
                document.querySelectorAll('.experiencia-entry').forEach(entry => {
                    const puesto = entry.querySelector('.experiencia-puesto').value;
                    const institucion = entry.querySelector('.experiencia-institucion').value;
                    const añoInicio = entry.querySelector('.experiencia-añoInicio').value;
                    const añoFin = entry.querySelector('.experiencia-añoFin').value;
                    experiencia.push({ puesto, institucion, añoInicio, añoFin });
                });

                // Obtener certificaciones
                const certificaciones = [];
                document.querySelectorAll('.certificacion-entry').forEach(entry => {
                    const nombre = entry.querySelector('.certificacion-nombre').value;
                    const institucion = entry.querySelector('.certificacion-institucion').value;
                    const año = entry.querySelector('.certificacion-año').value;
                    certificaciones.push({ nombre, institucion, año });
                });

                // Actualizar el documento en Firestore
                try {
                    const docRef = doc(db, "psicologos", `psicologo_${psicologoId}`);
                    await setDoc(docRef, {
                        nombre,
                        apellido,
                        pais,
                        correoElectronico,
                        telefono,
                        añosExperiencia,
                        idiomas,
                        precioServicioHora,
                        descripcion,
                        experiencia,
                        certificaciones
                    }, { merge: true });
                    alert('Perfil actualizado con éxito');
                    window.location.href = `perfil.html?id=${psicologoId}`;
                } catch (error) {
                    console.error("Error updating profile: ", error);
                }
            });

            // Agregar nueva entrada de experiencia
            document.getElementById('agregar-experiencia').addEventListener('click', function() {
                agregarEntradaExperiencia({}, document.querySelectorAll('.experiencia-entry').length);
            });

            // Agregar nueva entrada de certificación
            document.getElementById('agregar-certificacion').addEventListener('click', function() {
                agregarEntradaCertificacion({}, document.querySelectorAll('.certificacion-entry').length);
            });

            function agregarEntradaExperiencia(exp, index) {
                const experienciaContainer = document.getElementById('experiencia-container');
                const div = document.createElement('div');
                div.classList.add('experiencia-entry');
                div.innerHTML = `
                    <label for="experiencia-puesto-${index}">Puesto:</label>
                    <input type="text" class="experiencia-puesto" id="experiencia-puesto-${index}" value="${exp.puesto || ''}" required>
                    <label for="experiencia-institucion-${index}">Institución:</label>
                    <input type="text" class="experiencia-institucion" id="experiencia-institucion-${index}" value="${exp.institucion || ''}" required>
                    <label for="experiencia-añoInicio-${index}">Año de Inicio:</label>
                    <input type="number" class="experiencia-añoInicio" id="experiencia-añoInicio-${index}" value="${exp.añoInicio || ''}" required>
                    <label for="experiencia-añoFin-${index}">Año de Fin:</label>
                    <input type="number" class="experiencia-añoFin" id="experiencia-añoFin-${index}" value="${exp.añoFin || ''}" required>
                    <button type="button" class="eliminar-experiencia"></button>
                `;
                experienciaContainer.appendChild(div);

                div.querySelector('.eliminar-experiencia').addEventListener('click', function() {
                    div.remove();
                });
            }

            function agregarEntradaCertificacion(cert, index) {
                const certificacionesContainer = document.getElementById('certificaciones-container');
                const div = document.createElement('div');
                div.classList.add('certificacion-entry');
                div.innerHTML = `
                    <label for="certificacion-nombre-${index}">Nombre de Certificación:</label>
                    <input type="text" class="certificacion-nombre" id="certificacion-nombre-${index}" value="${cert.nombre || ''}" required>
                    <label for="certificacion-institucion-${index}">Institución:</label>
                    <input type="text" class="certificacion-institucion" id="certificacion-institucion-${index}" value="${cert.institucion || ''}" required>
                    <label for="certificacion-año-${index}">Año:</label>
                    <input type="number" class="certificacion-año" id="certificacion-año-${index}" value="${cert.año || ''}" required>
                    <button type="button" class="eliminar-certificacion"></button>
                `;
                certificacionesContainer.appendChild(div);

                div.querySelector('.eliminar-certificacion').addEventListener('click', function() {
                    div.remove();
                });
            }
        });
    </script>
</head>
<body>

    <header>
        <div class="logo"> 
            <img src="../../public/img/marca/logo cuatro.png" alt="Logo">
        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="../../index.html">Inicio</a></li>
                <li><a href="../../psicologos.html">Psicólogos Disponibles</a></li>
                <li><a href="../../historia.html">Tu Historia</a></li>
                <li><a href="../../reseñas.html">Reseñas</a></li>
                <li><a href="../../ofertas.html">Ofertas Laborales</a></li>
                <li><a href="https://forms.gle/XNqhQksUqjXX6B4p7">Registrarse</a></li>
            </ul>
            <ul class="nav-icons">
                <li><a href="../../index.html"><i class="fas fa-home"></i></a></li>
                <li><a href="../../psicologos.html"><i class="fas fa-user-md"></i></a></li>
                <li><a href="../../historia.html"><i class="fas fa-book"></i></a></li>
                <li><a href="../../reseñas.html"><i class="fa-solid fa-comments"></i></a></li>
                <li><a href="../../ofertas.html"><i class="fas fa-briefcase"></i></a></li>
                <li><a href="https://forms.gle/XNqhQksUqjXX6B4p7"><i class="fas fa-user-plus"></i></a></li>
            </ul>
        </nav> 
    </header>

    <main>
        <div class="edit-profile-container">
            <h2>¡EDITA TU PERFIL AQUÍ!</h2>
            <form id="editForm">
                <label for="nombre">Nombre:</label>
                <input type="text" id="nombre" required>
                
                <label for="apellido">Apellido:</label>
                <input type="text" id="apellido" required>
                
                <label for="pais">País:</label>
                <input type="text" id="pais" required>
                
                <label for="correoElectronico">Correo Electrónico:</label>
                <input type="email" id="correoElectronico" required>
                
                <label for="telefono">Teléfono:</label>
                <input type="tel" id="telefono" required>
                
                <label for="añosExperiencia">Años de Experiencia:</label>
                <input type="number" id="añosExperiencia" required>
                
                <label for="idiomas">Idiomas (separados por comas):</label>
                <input type="text" id="idiomas" required>
                
                <label for="precioServicioHora">Precio por Hora (USD):</label>
                <input type="number" id="precioServicioHora" required>
                
                <label for="descripcion">Descripción:</label>
                <textarea id="descripcion" required></textarea>
                
                <h3>Experiencia</h3>
                <div id="experiencia-container"></div>
                <button type="button" id="agregar-experiencia">Agregar Experiencia</button>
                
                <h3>Certificaciones</h3>
                <div id="certificaciones-container"></div>
                <button type="button" id="agregar-certificacion">Agregar Certificación</button>

                <button type="submit">Guardar Cambios ></button>
            </form>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-nav">
                <a href="#">EMPRESAS</a>
                <a href="https://forms.gle/xZERw5gE8yzQELDc8">REGISTRARSE</a>
                <a href="../../doc/pdf/TÉRMINOS Y CONDICIONES - PSYCONNECTS.pdf">TÉRMINOS Y CONDICIONES</a>
                <a href="#">QUIENES SOMOS</a>
            </div>
            <div class="footer-social">
                <a href="#"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Todos Los Derechos Reservados 2024 | @PsyConnects</p>
        </div>
    </footer>

</body>
</html>
