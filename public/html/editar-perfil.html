<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsyConnects | Mi Perfil</title>
    <link rel="stylesheet" href="../../public/css/styles.css">
    <link rel="shortcut icon" href="../../public/img/marca/icono.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-NSP4J1Q9MP"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-NSP4J1Q9MP');
</script>

<body>

    <header>
        <div class="logo">
            <img src="../../public/img/marca/icono 2.png" alt="Logo">
        </div>
        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>
        <nav class="nav-menu">
            <div class="close-menu">
                <i class="fas fa-times"></i>
            </div>
            <ul class="nav-links">
                <li><a href="../../index.html">üè† Inicio</a></li>
                <li><a href="../../psicologos.html">üß† Psic√≥logos Disponibles</a></li>
                <li><a href="https://forms.gle/9U59hSXHtxS7qRbD8" target="_blank">üì¢ Anunciarte</a></li>
                <li><a href="../../ofertas.html">üíº Ofertas Laborales</a></li>
                <li><a href="../../login.html">üë§ Mi Cuenta</a></li>
                <li><a href="register.html">üÜï Registrarse</a></li>
            </ul>
        </nav>

    </header>

    <main>
        <div class="bienvenida">
            <h2 id="titulo-bienvenida">¬°Bienvenido a tu perfil!</h2>
            <p style="color: white;">Aqu√≠ encontrar√°s m√°s informaci√≥n de tu inter√©s.</p>
        </div>
        <div class="contenedor-editar-perfil">
            <div class="perfil-usuario">
                <div class="foto-edicion-perfil">
                    <img id="imagen-perfil" src="ruta/a/tu/foto/default.jpg" alt="Foto de Perfil">
                    <label for="fotoPerfil" class="boton-subir-foto" title="Cambiar Foto">
                        üì∑
                    </label>
                    <input type="file" id="fotoPerfil" accept="image/*" style="display: none;">
                    <div id="upload-spinner" class="spinner" style="display: none;">
                        ‚è≥
                    </div>
                </div>
                <div class="informacion-perfil">
                    <div class="campo-perfil">
                        <label for="nombre">üë§ Nombre:</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="campo-perfil">
                        <label for="apellido">üë• Apellido:</label>
                        <input type="text" id="apellido" required>
                    </div>
                    <div class="campo-perfil">
                        <label for="correoElectronico">üìß Correo Electr√≥nico:</label>
                        <input type="email" id="correoElectronico" required disabled>
                    </div>
                    <div class="campo-perfil">
                        <label for="telefono">üìû Tel√©fono:</label>
                        <input type="tel" id="telefono" required>
                    </div>
                    <div class="campo-perfil">
                        <label for="pais">üåç Pa√≠s:</label>
                        <select id="pais" required>
                            <option value="">Selecciona tu pa√≠s</option>
                            <option value="Argentina">Argentina</option>
                            <option value="Bolivia">Bolivia</option>
                            <option value="Brasil">Brasil</option>
                            <option value="Chile">Chile</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Costa Rica">Costa Rica</option>
                            <option value="Cuba">Cuba</option>
                            <option value="Ecuador">Ecuador</option>
                            <option value="El Salvador">El Salvador</option>
                            <option value="Espa√±a">Espa√±a</option>
                            <option value="Guatemala">Guatemala</option>
                            <option value="Honduras">Honduras</option>
                            <option value="M√©xico">M√©xico</option>
                            <option value="Nicaragua">Nicaragua</option>
                            <option value="Panam√°">Panam√°</option>
                            <option value="Paraguay">Paraguay</option>
                            <option value="Per√∫">Per√∫</option>
                            <option value="Puerto Rico">Puerto Rico</option>
                            <option value="Rep√∫blica Dominicana">Rep√∫blica Dominicana</option>
                            <option value="Uruguay">Uruguay</option>
                            <option value="Venezuela">Venezuela</option>
                        </select>
                    </div>
                    <div class="campo-perfil">
                        <label for="fechaNacimiento">üéÇ Fecha de Nacimiento:</label>
                        <input type="date" id="fechaNacimiento" required>
                    </div>
                </div>
            </div>

            <div class="detalles-profesionales card">
                <h3>Detalles Profesionales</h3>
                <div class="campo-detalle">
                    <div class="campo-detalle-item">
                        <label for="a√±osExperiencia">üïí A√±os de Experiencia:</label>
                        <input type="number" id="a√±osExperiencia" required>
                    </div>
                    <div class="campo-detalle-item">
                        <label for="precioServicioHora">üí≤ Precio por Hora (USD):</label>
                        <input type="number" id="precioServicioHora" required>
                    </div>
                    <div class="campo-detalle-item">
                        <label for="descripcion">üìù Descripci√≥n:</label>
                        <textarea id="descripcion" required></textarea>
                    </div>
                    <div class="campo-detalle-item">
                        <label>üíº Tipos de Terapias:</label>
                        <div id="tiposTerapia" class="lista-checkbox personalizada">
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia Cognitivo-Conductual">
                                <span>Terapia Cognitivo-Conductual</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia Humanista">
                                <span>Terapia Humanista</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia Psicoanal√≠tica">
                                <span>Terapia Psicoanal√≠tica</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia Gestalt">
                                <span>Terapia Gestalt</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia de Aceptaci√≥n y Compromiso">
                                <span>Terapia de Aceptaci√≥n y Compromiso</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia Familiar">
                                <span>Terapia Familiar</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia de Pareja">
                                <span>Terapia de Pareja</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia de Juego">
                                <span>Terapia de Juego</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" class="tipo-terapia" value="Terapia EMDR">
                                <span>Terapia EMDR</span>
                            </label>
                        </div>
                    </div>
                    <div class="campo-detalle-item">
                        <label>üó£Ô∏è Idiomas:</label>
                        <div id="idiomas" class="lista-checkbox personalizada">
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Espa√±ol">
                                <span>Espa√±ol</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Ingl√©s">
                                <span>Ingl√©s</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Portugu√©s">
                                <span>Portugu√©s</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Franc√©s">
                                <span>Franc√©s</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Italiano">
                                <span>Italiano</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Alem√°n">
                                <span>Alem√°n</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Chino">
                                <span>Chino</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="Japon√©s">
                                <span>Japon√©s</span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" name="idiomas" value="√Årabe">
                                <span>√Årabe</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="experiencia-certificaciones card">
                <h3>Experiencia y Certificaciones</h3>
                <div class="seccion">
                    <h4>Experiencia Profesional üè¢</h4>
                    <div id="experiencia-container"></div>
                    <button type="button" id="agregar-experiencia" class="boton-agregar">‚ûï Agregar Experiencia</button>
                </div>
                <div class="seccion">
                    <h4>Certificaciones üìë</h4>
                    <div id="certificaciones-container"></div>
                    <button type="button" id="agregar-certificacion" class="boton-agregar">‚ûï Agregar
                        Certificaci√≥n</button>
                </div>
            </div>

            <div class="redes-sociales card">
                <h3>Redes Sociales</h3>
                <div class="campo-red-social">
                    <span class="icono-red-social"><i class="fab fa-instagram"></i></span>
                    <label for="instagram">Instagram:</label>
                    <input type="url" id="instagram" placeholder="https://www.instagram.com/tuusuario">
                </div>
                <div class="campo-red-social">
                    <span class="icono-red-social"><i class="fab fa-facebook"></i></span>
                    <label for="facebook">Facebook:</label>
                    <input type="url" id="facebook" placeholder="https://www.facebook.com/tuusuario">
                </div>
                <div class="campo-red-social">
                    <span class="icono-red-social"><i class="fab fa-linkedin"></i></span>
                    <label for="linkedin">LinkedIn:</label>
                    <input type="url" id="linkedin" placeholder="https://www.linkedin.com/in/tuusuario">
                </div>
                <div class="campo-red-social">
                    <span class="icono-red-social"><i class="fab fa-tiktok"></i></span>
                    <label for="tiktok">TikTok:</label>
                    <input type="url" id="tiktok" placeholder="https://www.tiktok.com/@tuusuario">
                </div>
            </div>

            <button type="submit" id="guardarCambios" class="boton-guardar">Guardar Cambios</button>
            <button type="button" id="eliminarPerfil" class="boton-guardar">Eliminar Perfil</button>
        </div>
        <div class="datos-generales-perfil">
            <h2 id="titulo-datos-generales-perfil">Datos sobre tu perfil üìä</h2>
        </div>

        <div class="contador-visitas">
            <div class="numero-visitas-container">
                <span id="numero-visitas">0</span>
            </div>
            <p class="etiqueta-visitas">N√∫mero de visitas al perfil</p>
        </div>

        <div class="datos-generales-perfil">
            <h2 id="titulo-datos-generales-perfil">Calendario de disponibilidad üìÖ</h2>
        </div>

        <div class="seccion-calendario card">
            <div id="calendar"></div>
        </div>

        <div id="alert-container"></div>

        <div id="modalCrop">
            <div class="modalCrop-content">
                <div class="cropper-container">
                    <img id="imageToCrop" alt="Imagen a recortar">
                </div>

                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" alt="Vista previa circular">
                </div>

                <div class="btn-cropper">
                    <button id="cancelCrop">Cancelar</button>
                    <button id="confirmCrop">Recortar</button>
                </div>
            </div>
        </div>

    </main>

    <footer>

        <div class="footer-container">
            <div class="footer-nav">
                <a href="#">EMPRESAS</a>
                <a href="#">REGISTRARSE</a>
                <a href="../../doc/pdf/T√âRMINOS Y CONDICIONES - PSYCONNECTS.pdf">T√âRMINOS Y CONDICIONES</a>
                <a href="#">QUIENES SOMOS</a>
            </div>
            <div class="footer-social">
                <a href="https://www.instagram.com/psyconnects/"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/profile.php?id=61564496164581"><i class="fab fa-facebook"></i></a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Todos Los Derechos Reservados 2024 | @PsyConnects</p>
        </div>

    </footer>

    <link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.css" />
    <script src="https://unpkg.com/cropperjs/dist/cropper.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
        import { getAuth, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3YzDZbNdjZJL5siTvV9N2n1-z_tI5BvQ",
            authDomain: "psyconnects-7be13.firebaseapp.com",
            projectId: "psyconnects-7be13",
            storageBucket: "psyconnects-7be13.appspot.com",
            messagingSenderId: "299531221809",
            appId: "1:299531221809:web:c6bba4831be2d70d910e10",
            measurementId: "G-FKC5P4PE6V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let cropper = null;
        let croppedFile = null;

        function cargarEntradas(dataArray, containerId, entryClass, isExperience = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            dataArray.forEach((data, index) => {
                agregarEntrada(containerId, entryClass, data, index, isExperience);
            });
        }

        function agregarEntrada(containerId, entryClass, data = {}, index, isExperience = false) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.classList.add(entryClass);

            if (isExperience) {
                div.innerHTML = `
                    <label>Puesto:</label>
                    <input type="text" value="${data.puesto || ''}" required>
                    <label>Instituci√≥n:</label>
                    <input type="text" value="${data.institucion || ''}" required>
                    <label>A√±o de Inicio:</label>
                    <input type="number" value="${data.a√±oInicio || ''}" required>
                    <label>A√±o de Fin:</label>
                    <input type="number" class="a√±oFin" value="${data.a√±oFin || ''}" ${data.actualidad ? 'disabled' : ''}>
                    <label>Actualidad:</label>
                    <input type="checkbox" class="actualidad" ${data.actualidad ? 'checked' : ''}>
                    <button type="button" class="eliminar" title="Eliminar">√ó</button>
                `;
                const a√±oFinInput = div.querySelector('.a√±oFin');
                const actualidadCheckbox = div.querySelector('.actualidad');

                actualidadCheckbox.addEventListener('change', function () {
                    if (actualidadCheckbox.checked) {
                        a√±oFinInput.disabled = true;
                        a√±oFinInput.value = '';
                    } else {
                        a√±oFinInput.disabled = false;
                    }
                });
            } else {
                div.innerHTML = `
                    <label>Nombre de Certificaci√≥n:</label>
                    <input type="text" value="${data.nombre || ''}" required>
                    <label>Instituci√≥n:</label>
                    <input type="text" value="${data.institucion || ''}" required>
                    <label>A√±o:</label>
                    <input type="number" value="${data.a√±o || ''}" required>
                    <button type="button" class="eliminar" title="Eliminar">√ó</button>
                `;
            }

            container.appendChild(div);
            div.querySelector('.eliminar').addEventListener('click', () => div.remove());
        }

        function mostrarAlerta(tipo, titulo, mensaje) {
            return new Promise((resolve) => {
                const alertContainer = document.getElementById('alert-container');

                const alert = document.createElement('div');
                alert.classList.add('alert');
                alert.classList.add(tipo === 'success' ? 'alert-success' : 'alert-error');

                alert.innerHTML = `
                    <div>
                        <strong>${titulo}</strong><br>
                        <span>${mensaje}</span>
                    </div>
                    <button class="close-btn">&times;</button>
                `;

                alertContainer.appendChild(alert);

                const closeBtn = alert.querySelector('.close-btn');
                closeBtn.addEventListener('click', () => cerrarAlerta(alert, resolve));

                setTimeout(() => cerrarAlerta(alert, resolve), 5000);
            });
        }

        function cerrarAlerta(alert, resolve) {
            alert.style.animation = 'slide-out 0.5s forwards';
            alert.addEventListener('animationend', () => {
                alert.remove();
                resolve();
            });
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const psicologoId = urlParams.get('id');

            if (!psicologoId) {
                mostrarAlerta('error', 'Error', 'ID de psic√≥logo no encontrado en la URL.');
                return;
            }

            const docRef = doc(db, "psicologos", psicologoId);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const psicologo = docSnap.data();

                    document.getElementById('nombre').value = psicologo.nombre || '';
                    document.getElementById('apellido').value = psicologo.apellido || '';
                    document.getElementById('pais').value = psicologo.pais || '';
                    document.getElementById('correoElectronico').value = psicologo.correoElectronico || '';
                    document.getElementById('telefono').value = psicologo.telefono || '';
                    document.getElementById('fechaNacimiento').value = psicologo.fechaNacimiento || '';
                    document.getElementById('a√±osExperiencia').value = psicologo.a√±osExperiencia || '';
                    document.getElementById('precioServicioHora').value = psicologo.precioServicioHora || '';
                    document.getElementById('descripcion').value = psicologo.descripcion || '';

                    if (psicologo.idiomas) {
                        document.querySelectorAll('#idiomas input[name="idiomas"]').forEach(checkbox => {
                            checkbox.checked = psicologo.idiomas.includes(checkbox.value);
                        });
                    }

                    if (psicologo.tiposTerapia) {
                        document.querySelectorAll('.tipo-terapia').forEach(checkbox => {
                            checkbox.checked = psicologo.tiposTerapia.includes(checkbox.value);
                        });
                    }

                    if (psicologo.experiencia) {
                        cargarEntradas(psicologo.experiencia, 'experiencia-container', 'experiencia-entry', true);
                    } else {
                        document.getElementById('experiencia-container').innerHTML = '';
                    }
                    if (psicologo.certificaciones) {
                        cargarEntradas(psicologo.certificaciones, 'certificaciones-container', 'certificacion-entry');
                    } else {
                        document.getElementById('certificaciones-container').innerHTML = '';
                    }

                    document.getElementById('instagram').value = psicologo.redesSociales?.instagram || '';
                    document.getElementById('facebook').value = psicologo.redesSociales?.facebook || '';
                    document.getElementById('linkedin').value = psicologo.redesSociales?.linkedin || '';
                    document.getElementById('tiktok').value = psicologo.redesSociales?.tiktok || '';

                    const imagenPerfil = document.getElementById('imagen-perfil');
                    if (psicologo.fotoPerfil) {
                        imagenPerfil.src = psicologo.fotoPerfil;
                    } else {
                        imagenPerfil.src = 'ruta/a/tu/foto/default.jpg';
                    }

                    const tituloBienvenida = document.getElementById('titulo-bienvenida');
                    if (tituloBienvenida) {
                        tituloBienvenida.textContent = `¬°Bienvenido ${psicologo.nombre} a tu perfil!`;
                    }

                    const numeroVisitasElement = document.getElementById('numero-visitas');
                    if (numeroVisitasElement) {
                        const visitas = psicologo.visitas || 0;
                        numeroVisitasElement.innerText = visitas;
                    }

                } else {
                    mostrarAlerta('error', 'Error', 'Psic√≥logo no encontrado en la base de datos.');
                }
            });

            document.getElementById('agregar-experiencia').addEventListener('click', () => {
                agregarEntrada('experiencia-container', 'experiencia-entry', {}, document.querySelectorAll('.experiencia-entry').length, true);
            });

            document.getElementById('agregar-certificacion').addEventListener('click', () => {
                agregarEntrada('certificaciones-container', 'certificacion-entry');
            });

            const fotoPerfilInput = document.getElementById('fotoPerfil');
            const imagenPerfil = document.getElementById('imagen-perfil');
            const uploadSpinner = document.getElementById('upload-spinner');

            const modalCrop = document.getElementById('modalCrop');
            const imageToCrop = document.getElementById('imageToCrop');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const cancelCropBtn = document.getElementById('cancelCrop');
            const confirmCropBtn = document.getElementById('confirmCrop');

            fotoPerfilInput.addEventListener('change', function () {
                const file = this.files[0];
                if (!file) return;

                croppedFile = null;

                modalCrop.classList.add('active');

                const reader = new FileReader();
                reader.onload = function (e) {
                    imageToCrop.src = e.target.result;

                    imageToCrop.onload = function () {
                        if (cropper) {
                            cropper.destroy();
                        }
                        cropper = new Cropper(imageToCrop, {
                            aspectRatio: 1,
                            viewMode: 1,
                            preview: previewContainer,
                            ready() {
                                previewContainer.style.display = 'block';
                            },
                            crop() {
                                const canvas = cropper.getCroppedCanvas({
                                    width: 200,
                                    height: 200
                                });
                                previewImage.src = canvas.toDataURL('image/jpeg');
                            }
                        });
                    };
                };
                reader.readAsDataURL(file);
            });

            cancelCropBtn.addEventListener('click', () => {
                modalCrop.classList.remove('active');
                fotoPerfilInput.value = "";
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            });

            confirmCropBtn.addEventListener('click', () => {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 300,
                        height: 300
                    });

                    canvas.toBlob((blob) => {
                        if (blob) {
                            const file = new File([blob], 'perfil_recortado.jpg', { type: 'image/jpeg' });
                            croppedFile = file;

                            const reader = new FileReader();
                            reader.onload = function (e) {
                                imagenPerfil.src = e.target.result;
                            };
                            reader.readAsDataURL(croppedFile);
                        }
                    }, 'image/jpeg', 0.9);

                    modalCrop.classList.remove('active');
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                }
            });

            document.getElementById('guardarCambios').addEventListener('click', async function (event) {
                event.preventDefault();

                let isUploading = false;

                const nombre = document.getElementById('nombre').value.trim();
                const apellido = document.getElementById('apellido').value.trim();
                const telefono = document.getElementById('telefono').value.trim();
                const pais = document.getElementById('pais').value;
                const fechaNacimiento = document.getElementById('fechaNacimiento').value;
                const a√±osExperiencia = document.getElementById('a√±osExperiencia').value;
                const precioServicioHora = document.getElementById('precioServicioHora').value;
                const descripcion = document.getElementById('descripcion').value.trim();

                if (!nombre || !apellido || !telefono || !pais || !fechaNacimiento || !a√±osExperiencia || !precioServicioHora || !descripcion) {
                    mostrarAlerta('error', 'Campos incompletos', 'Por favor, completa todos los campos requeridos.');
                    return;
                }

                const idiomas = Array.from(document.querySelectorAll('#idiomas input:checked')).map(cb => cb.value);
                const tiposTerapia = Array.from(document.querySelectorAll('.tipo-terapia:checked')).map(cb => cb.value);

                const experiencia = Array.from(document.querySelectorAll('.experiencia-entry')).map(entry => ({
                    puesto: entry.querySelector('input[type="text"]').value.trim(),
                    institucion: entry.querySelectorAll('input[type="text"]')[1].value.trim(),
                    a√±oInicio: entry.querySelector('input[type="number"]').value.trim(),
                    a√±oFin: entry.querySelector('.a√±oFin').disabled ? 'Actualidad' : entry.querySelector('.a√±oFin').value.trim(),
                    actualidad: entry.querySelector('.actualidad').checked
                }));

                const certificaciones = Array.from(document.querySelectorAll('.certificacion-entry')).map(entry => ({
                    nombre: entry.querySelector('input[type="text"]').value.trim(),
                    institucion: entry.querySelectorAll('input[type="text"]')[1].value.trim(),
                    a√±o: entry.querySelector('input[type="number"]').value.trim()
                }));

                const instagram = document.getElementById('instagram').value.trim() || null;
                const facebook = document.getElementById('facebook').value.trim() || null;
                const linkedin = document.getElementById('linkedin').value.trim() || null;
                const tiktok = document.getElementById('tiktok').value.trim() || null;

                const originalFile = fotoPerfilInput.files[0];
                const fileToUpload = croppedFile || originalFile;

                try {
                    if (fileToUpload) {
                        isUploading = true;
                        uploadSpinner.style.display = 'flex';

                        const storageRef = ref(storage, `perfil_fotos/${psicologoId}`);
                        const uploadTask = uploadBytesResumable(storageRef, fileToUpload);

                        uploadTask.on('state_changed',
                            (snapshot) => { },
                            (error) => {
                                console.error("Error al subir la imagen: ", error);
                                mostrarAlerta('error', 'Error', 'Hubo un error al subir la imagen. Por favor, intenta de nuevo.');
                                uploadSpinner.style.display = 'none';
                                isUploading = false;
                            },
                            async () => {
                                const fotoPerfilUrl = await getDownloadURL(uploadTask.snapshot.ref);
                                await updateDoc(docRef, {
                                    nombre,
                                    apellido,
                                    pais,
                                    telefono,
                                    fechaNacimiento,
                                    a√±osExperiencia,
                                    precioServicioHora,
                                    descripcion,
                                    idiomas,
                                    tiposTerapia,
                                    experiencia,
                                    certificaciones,
                                    fotoPerfil: fotoPerfilUrl,
                                    redesSociales: {
                                        instagram,
                                        facebook,
                                        linkedin,
                                        tiktok
                                    }
                                });
                                mostrarAlerta('success', '¬°Cambios Realizados!', 'Sigue disfrutando de PsyConnects. üòç').then(() => {
                                    window.location.href = '../../psicologos.html';
                                });
                            }
                        );
                    } else {
                        await updateDoc(docRef, {
                            nombre,
                            apellido,
                            pais,
                            telefono,
                            fechaNacimiento,
                            a√±osExperiencia,
                            precioServicioHora,
                            descripcion,
                            idiomas,
                            tiposTerapia,
                            experiencia,
                            certificaciones,
                            redesSociales: {
                                instagram,
                                facebook,
                                linkedin,
                                tiktok
                            }
                        });
                        mostrarAlerta('success', '¬°Cambios Realizados!', 'Sigue disfrutando de PsyConnects. üòç').then(() => {
                            window.location.href = '../../psicologos.html';
                        });
                    }
                } catch (error) {
                    console.error("Error al guardar los cambios: ", error);
                    mostrarAlerta('error', 'Error', 'Hubo un error al guardar los cambios. Por favor, intenta de nuevo.');
                } finally {
                    if (isUploading) {
                        uploadSpinner.style.display = 'none';
                        isUploading = false;
                    }
                }
            });

            const menuToggle = document.querySelector('.menu-toggle');
            const navMenu = document.querySelector('.nav-menu');

            if (menuToggle && navMenu) {
                menuToggle.addEventListener('click', function () {
                    navMenu.classList.add('active');
                });
            }

            const closeMenu = document.querySelector('.close-menu');
            if (closeMenu && navMenu) {
                closeMenu.addEventListener('click', function () {
                    navMenu.classList.remove('active');
                });
            }

            const disponibilidadRef = doc(db, "psicologos", psicologoId);

            const calendar = document.getElementById('calendar');
            const monthNames = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();

            function createLeftArrowSVG() {
                return `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
            }

            function createRightArrowSVG() {
                return `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;
            }

            function renderCalendar(month, year) {
                calendar.innerHTML = '';

                const header = document.createElement('div');
                header.classList.add('calendar-header');

                const prevBtn = document.createElement('button');
                prevBtn.classList.add('nav-btn', 'prev-btn');
                prevBtn.setAttribute('aria-label', 'Mes Anterior');
                prevBtn.innerHTML = createLeftArrowSVG();
                prevBtn.addEventListener('click', () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    renderCalendar(currentMonth, currentYear);
                });

                const nextBtn = document.createElement('button');
                nextBtn.classList.add('nav-btn', 'next-btn');
                nextBtn.setAttribute('aria-label', 'Mes Siguiente');
                nextBtn.innerHTML = createRightArrowSVG();
                nextBtn.addEventListener('click', () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    renderCalendar(currentMonth, currentYear);
                });

                const monthYear = document.createElement('div');
                monthYear.classList.add('month-year');
                monthYear.innerHTML = `<span class="month-name">${monthNames[month]}</span> <span class="year">${year}</span>`;

                header.appendChild(prevBtn);
                header.appendChild(monthYear);
                header.appendChild(nextBtn);
                calendar.appendChild(header);

                const grid = document.createElement('div');
                grid.classList.add('calendar-grid');

                const daysOfWeek = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
                daysOfWeek.forEach(day => {
                    const dayElem = document.createElement('div');
                    dayElem.classList.add('calendar-day-name');
                    dayElem.innerHTML = `<strong>${day}</strong>`;
                    grid.appendChild(dayElem);
                });

                const firstDay = new Date(year, month, 1).getDay();
                const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < adjustedFirstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('calendar-day', 'disabled');
                    grid.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('calendar-day');
                    dayCell.textContent = day;

                    const formattedDate = date.toISOString().split('T')[0];

                    const disponibilidadDia = disponibilidadData[formattedDate] || [];

                    if (disponibilidadDia.length > 0) {
                        dayCell.classList.add('marked');
                    }

                    dayCell.addEventListener('click', () => openHoursPopup(date, dayCell));

                    grid.appendChild(dayCell);
                }

                calendar.appendChild(grid);
            }

            let disponibilidadData = {};

            function getDisponibilidad() {
                onSnapshot(disponibilidadRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        disponibilidadData = data.disponibilidad || {};
                        renderCalendar(currentMonth, currentYear);
                    } else {
                        setDoc(disponibilidadRef, { disponibilidad: {} });
                        disponibilidadData = {};
                        renderCalendar(currentMonth, currentYear);
                    }
                }, (error) => {
                    console.error("Error al obtener la disponibilidad: ", error);
                    mostrarAlerta('error', 'Error', 'Hubo un error al obtener la disponibilidad.');
                });
            }

            function openHoursPopup(date, dayCell) {
                const formattedDate = date.toISOString().split('T')[0];

                const overlay = document.createElement('div');
                overlay.classList.add('overlay');

                const popup = document.createElement('div');
                popup.classList.add('hours-popup');

                const horasExistentes = disponibilidadData[formattedDate] || [];

                popup.innerHTML = `
                    <h4>${formattedDate}</h4>
                    <div id="horas-lista">
                        ${horasExistentes.map(hora => `<div class="hora-item">
                            <span>${hora}</span>
                            <button class="eliminar-hora" data-hora="${hora}">&times;</button>
                        </div>`).join('')}
                    </div>
                    <input type="time" id="nueva-hora" placeholder="Selecciona una hora">
                    <div class="buttons">
                        <button class="save-btn">Guardar</button>
                        <button class="close-btn">Cerrar</button>
                    </div>
                `;

                overlay.appendChild(popup);
                document.body.appendChild(overlay);

                const eliminarBtns = popup.querySelectorAll('.eliminar-hora');
                eliminarBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const hora = btn.getAttribute('data-hora');
                        const index = horasExistentes.indexOf(hora);
                        if (index > -1) {
                            horasExistentes.splice(index, 1);
                            disponibilidadData[formattedDate] = horasExistentes;
                            updateFirestore(formattedDate, horasExistentes);
                            popup.querySelector('#horas-lista').innerHTML = horasExistentes.map(h => `<div class="hora-item">
                                <span>${h}</span>
                                <button class="eliminar-hora" data-hora="${h}">&times;</button>
                            </div>`).join('');
                        }
                    });
                });

                const nuevaHoraInput = popup.querySelector('#nueva-hora');
                const saveBtn = popup.querySelector('.save-btn');
                const closeBtn = popup.querySelector('.close-btn');

                saveBtn.addEventListener('click', () => {
                    const nuevaHora = nuevaHoraInput.value;
                    if (nuevaHora && !horasExistentes.includes(nuevaHora)) {
                        horasExistentes.push(nuevaHora);
                        disponibilidadData[formattedDate] = horasExistentes;
                        updateFirestore(formattedDate, horasExistentes);
                        popup.querySelector('#horas-lista').innerHTML += `
                            <div class="hora-item">
                                <span>${nuevaHora}</span>
                                <button class="eliminar-hora" data-hora="${nuevaHora}">&times;</button>
                            </div>
                        `;
                        const newEliminarBtn = popup.querySelector(`.eliminar-hora[data-hora="${nuevaHora}"]`);
                        newEliminarBtn.addEventListener('click', () => {
                            const hora = newEliminarBtn.getAttribute('data-hora');
                            const index = horasExistentes.indexOf(hora);
                            if (index > -1) {
                                horasExistentes.splice(index, 1);
                                disponibilidadData[formattedDate] = horasExistentes;
                                updateFirestore(formattedDate, horasExistentes);
                                popup.querySelector('#horas-lista').innerHTML = horasExistentes.map(h => `<div class="hora-item">
                                    <span>${h}</span>
                                    <button class="eliminar-hora" data-hora="${h}">&times;</button>
                                </div>`).join('');
                            }
                        });
                        nuevaHoraInput.value = '';
                        dayCell.classList.add('marked');
                    }
                });

                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                });
            }

            async function updateFirestore(fecha, horas) {
                try {
                    await updateDoc(disponibilidadRef, {
                        [`disponibilidad.${fecha}`]: horas
                    });
                    mostrarAlerta('success', 'Disponibilidad Actualizada', `Horas disponibles para el ${fecha} han sido actualizadas.`);
                    renderCalendar(currentMonth, currentYear);
                } catch (error) {
                    console.error("Error al actualizar la disponibilidad: ", error);
                    mostrarAlerta('error', 'Error', 'Hubo un error al actualizar la disponibilidad. Por favor, intenta de nuevo.');
                }
            }

            getDisponibilidad();

            const eliminarPerfilBtn = document.getElementById('eliminarPerfil');
            eliminarPerfilBtn.addEventListener('click', async () => {
                const confirmacion = confirm("¬øEst√°s seguro? Queremos seguir compartiendo experiencias contigo üòä");

                if (confirmacion) {
                    try {
                        const user = auth.currentUser;
                        if (!user) {
                            mostrarAlerta('error', 'Error', 'No hay un usuario autenticado.');
                            return;
                        }

                        const psicologoId = user.uid;

                        const fotoPerfilUrl = document.getElementById('imagen-perfil').src;
                        if (fotoPerfilUrl && !fotoPerfilUrl.includes('default.jpg')) {
                            const fotoRef = ref(storage, `perfil_fotos/${psicologoId}`);
                            await deleteObject(fotoRef);
                        }

                        const userDocRef = doc(db, "psicologos", psicologoId);
                        await deleteDoc(userDocRef);

                        await deleteUser(user);

                        mostrarAlerta('success', 'Perfil Eliminado', 'Tu perfil ha sido eliminado con √©xito.');

                        setTimeout(() => {
                            window.location.href = 'ruta/a/la/p√°gina/de/inicio';
                        }, 3000);

                    } catch (error) {
                        console.error("Error al eliminar el perfil: ", error);
                        mostrarAlerta('error', 'Error', 'Hubo un problema al eliminar tu perfil. Por favor, intenta de nuevo.');
                    }
                }
            });
        });

        function createLeftArrowSVG() {
            return `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        `;
        }

        function createRightArrowSVG() {
            return `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        `;
        }
        
    </script>

</body>

</html>